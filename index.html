<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Folder Portal - WebXR Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
            max-width: 300px;
        }
        
        #startAR {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            font-size: 18px;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(255,107,53,0.4);
        }
        
        #startAR:hover {
            background: #e55a2b;
        }
    </style>
</head>
<body>
    <div id="info">
        <h3>üóÇÔ∏è AR Folder Portal</h3>
        <p>Tap "Enter AR" ‚Üí Point at ground ‚Üí Touch screen to place objects!</p>
        <p><strong>Demo by:</strong> xrdevsg</p>
    </div>
    
    <button id="startAR">Enter AR Mode</button>
    
    <script>
        let scene, camera, renderer, session, referenceSpace;
        let placedObjects = [];
        let isARActive = false;
        
        // Initialize the scene
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);
            
            // Lighting
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            scene.add(light);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Start render loop
            renderer.setAnimationLoop(render);
        }
        
        function createObjectAt(position, type = 'cube') {
            let geometry;
            let color;
            
            switch(type) {
                case 'sphere':
                    geometry = new THREE.SphereGeometry(0.05, 16, 16);
                    color = 0x4ecdc4;
                    break;
                case 'cone':
                    geometry = new THREE.ConeGeometry(0.05, 0.1, 8);
                    color = 0x45b7d1;
                    break;
                case 'cylinder':
                    geometry = new THREE.CylinderGeometry(0.05, 0.05, 0.1, 8);
                    color = 0x96ceb4;
                    break;
                default: // cube
                    geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
                    color = 0xff6b35;
            }
            
            const material = new THREE.MeshLambertMaterial({ color: color });
            const mesh = new THREE.Mesh(geometry, material);
            
            mesh.position.copy(position);
            mesh.position.y += 0.05; // Slightly above surface
            
            // Add animation
            const startTime = Date.now();
            function animate() {
                const elapsed = (Date.now() - startTime) * 0.001;
                mesh.rotation.y += 0.01;
                mesh.position.y = position.y + 0.05 + Math.sin(elapsed * 3) * 0.01;
                
                if (scene.children.includes(mesh)) {
                    requestAnimationFrame(animate);
                }
            }
            animate();
            
            scene.add(mesh);
            placedObjects.push(mesh);
            
            // Update UI
            updateObjectCount();
        }
        
        function updateObjectCount() {
            if (isARActive) {
                const infoDiv = document.getElementById('info');
                if (infoDiv) {
                    infoDiv.innerHTML = `
                        <h3>üéâ AR Active!</h3>
                        <p>Tap screen to place objects!</p>
                        <p>Objects placed: ${placedObjects.length}</p>
                        <p><small>Tap objects to cycle types</small></p>
                    `;
                }
            }
        }
        
        function onSelect(event) {
            if (!isARActive || !referenceSpace) return;
            
            const controller = event.target;
            
            // Get controller position and place object there
            const tempMatrix = new THREE.Matrix4();
            tempMatrix.identity().extractRotation(controller.matrixWorld);
            
            const position = new THREE.Vector3();
            position.setFromMatrixPosition(controller.matrixWorld);
            
            // Move object in front of controller
            const direction = new THREE.Vector3(0, 0, -0.5);
            direction.applyMatrix4(tempMatrix);
            position.add(direction);
            
            // Cycle through object types
            const types = ['cube', 'sphere', 'cone', 'cylinder'];
            const typeIndex = placedObjects.length % types.length;
            
            createObjectAt(position, types[typeIndex]);
        }
        
        function render() {
            renderer.render(scene, camera);
        }
        
        // AR Session management - FIXED VERSION
        document.getElementById('startAR').addEventListener('click', async () => {
            console.log('Enter AR button clicked');
            document.getElementById('info').innerHTML = '<h3>üîÑ Starting AR...</h3><p>Checking WebXR support...</p>';
            
            if (!navigator.xr) {
                document.getElementById('info').innerHTML = '<h3>‚ö†Ô∏è WebXR Not Supported</h3>';
                return;
            }
            
            try {
                // Check AR support
                const isSupported = await navigator.xr.isSessionSupported('immersive-ar');
                if (!isSupported) {
                    document.getElementById('info').innerHTML = '<h3>‚ö†Ô∏è AR Not Supported</h3>';
                    return;
                }
                
                document.getElementById('info').innerHTML = '<h3>üîÑ Starting AR...</h3><p>Requesting camera permission...</p>';
                
                // Request AR session
                session = await navigator.xr.requestSession('immersive-ar');
                console.log('AR session created successfully!');
                
                document.getElementById('info').innerHTML = '<h3>üîÑ Starting AR...</h3><p>Setting up tracking...</p>';
                
                // Try different reference spaces until one works
                const spaceTypes = ['viewer', 'local', 'local-floor'];
                
                document.getElementById('info').innerHTML = '<h3>üîÑ Starting AR...</h3><p>Testing reference spaces...</p>';
                
                for (const spaceType of spaceTypes) {
                    try {
                        console.log(`Trying reference space: ${spaceType}`);
                        document.getElementById('info').innerHTML = `<h3>üîÑ Starting AR...</h3><p>Trying: ${spaceType}...</p>`;
                        
                        referenceSpace = await session.requestReferenceSpace(spaceType);
                        console.log(`‚úÖ Success with reference space: ${spaceType}`);
                        
                        document.getElementById('info').innerHTML = `<h3>üîÑ Starting AR...</h3><p>‚úÖ Using: ${spaceType}</p>`;
                        break;
                    } catch (e) {
                        console.log(`‚ùå Failed reference space ${spaceType}:`, e.message);
                        document.getElementById('info').innerHTML = `<h3>üîÑ Starting AR...</h3><p>‚ùå ${spaceType} failed: ${e.message}</p>`;
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 sec to see error
                    }
                }
                
                if (!referenceSpace) {
                    throw new Error('No supported reference space found: viewer, local, local-floor all failed');
                }
                
                // Set up controller for touch interaction
                const controller = renderer.xr.getController(0);
                controller.addEventListener('select', onSelect);
                scene.add(controller);
                
                // Start XR session
                await renderer.xr.setSession(session);
                console.log('‚úÖ AR session active!');
                
                document.getElementById('startAR').style.display = 'none';
                isARActive = true;
                updateObjectCount();
                
            } catch (error) {
                console.error('‚ùå AR failed:', error);
                document.getElementById('info').innerHTML = `
                    <h3>‚ùå AR Failed</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Your device may not support this AR feature.</p>
                    <button onclick="location.reload()">Try Again</button>
                `;
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Initialize everything
        init();
    </script>
</body>
</html>
